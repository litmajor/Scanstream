generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model MarketFrame {
  id                   String   @id @default(uuid())
  timestamp            DateTime @default(now())
  symbol               String
  price                Json
  volume               Float
  indicators           Json
  orderFlow            Json
  marketMicrostructure Json
}

model Signal {
  id                  String   @id @default(uuid())
  timestamp           DateTime @default(now())
  symbol              String
  type                String
  strength            Float
  confidence          Float
  price               Float
  reasoning           Json
  riskReward          Float
  stopLoss            Float
  takeProfit          Float
  momentumLabel       String?
  regimeState         String?
  legacyLabel         String?
  signalStrengthScore Float?
  userId              String?
}

model Trade {
  id         String    @id @default(uuid())
  symbol     String
  side       String
  entryTime  DateTime
  exitTime   DateTime?
  entryPrice Float
  exitPrice  Float?
  quantity   Float
  pnl        Float?
  commission Float     @default(0)
  status     String    @default("OPEN")
}

model Strategy {
  id          String           @id @default(uuid())
  name        String
  description String
  riskParams  Json
  performance Json
  isActive    Boolean          @default(true)
  backtests   BacktestResult[]
}

model BacktestResult {
  id             String   @id @default(uuid())
  strategyId     String
  startDate      DateTime
  endDate        DateTime
  initialCapital Float
  finalCapital   Float
  performance    Json
  equityCurve    Json
  monthlyReturns Json
  createdAt      DateTime @default(now())
  metrics        Json
  trades         Json
  strategy       Strategy @relation(fields: [strategyId], references: [id])
}

model MarketSentiment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  data      Json
}

model PortfolioSummary {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  data      Json
}

model Watchlist {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  symbol    String
  addedAt   DateTime @default(now())
  notes     String?

  @@unique([userId, symbol])
  @@index([userId])
}

model Portfolio {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings  Json     @default("[]")
  totalCost Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt
}

model User {
  id              String   @id @default(uuid())
  email           String?  @unique
  firstName       String?
  lastName        String?
  profileImageUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  preferences     UserPreference?
  apiKeys         ApiKey[]
  watchlist       Watchlist[]
  portfolio       Portfolio?
}

model Session {
  sid    String   @id
  sess   Json
  expire DateTime

  @@index([expire])
}

model UserPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme                 String   @default("dark")
  defaultTimeframe      String   @default("1h")
  defaultExchange       String   @default("binance")
  notificationsEnabled  Boolean  @default(true)
  emailAlerts           Boolean  @default(false)
  priceAlerts           Boolean  @default(true)
  signalAlerts          Boolean  @default(true)
  soundEnabled          Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @default(now()) @updatedAt
}

model ApiKey {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exchange    String
  name        String
  apiKey      String
  apiSecret   String
  isTestnet   Boolean  @default(false)
  isActive    Boolean  @default(true)
  permissions Json     @default("[]")
  lastValidated DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([userId])
}
